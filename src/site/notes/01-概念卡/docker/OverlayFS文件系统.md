---
{"dg-publish":true,"permalink":"/01-概念卡/docker/OverlayFS文件系统/","tags":["文件系统","overlayfs","存储驱动","概念卡","tech/docker"]}
---

## 1. 定义
OverlayFS 是一种**堆叠文件系统**（Union File System），它建立在其他文件系统之上（如 ext4、xfs），通过将多个目录层"合并"展示为统一的目录结构，而不直接参与磁盘空间划分。

## 2. 核心概念

### 2.1. 四层结构
```
┌─────────────────┐
│  merged 层      │ ← 用户视图（合并展示）
├─────────────────┤
│  upper 层       │ ← 读写层（容器层）
├─────────────────┤
│  lower 层       │ ← 只读层（镜像层）
├─────────────────┤
│  work 层        │ ← 工作目录（内部使用）
└─────────────────┘
```

![overlayFS文件夹系统.png](/img/user/attachment/overlayFS%E6%96%87%E4%BB%B6%E5%A4%B9%E7%B3%BB%E7%BB%9F.png)

**各层说明：**
- **lower 层**: 只读层，存储基础镜像和系统文件
- **upper 层**: 读写层，存储容器运行时的修改
- **merged 层**: 合并视图，向用户展示 lower + upper 的联合结果
- **work 层**: OverlayFS 内部工作目录，用于原子操作

## 3. 工作原理

### 3.1. 读操作
1. **文件在 upper 层** → 直接从 upper 层读取
2. **文件仅在 lower 层** → 从 lower 层读取
3. **文件在两层都存在** → 优先读取 upper 层（覆盖机制）

### 3.2. 写操作

#### 3.2.1. 修改文件
- **场景**: 修改 lower 层的文件
- **机制**: Copy-on-Write (CoW)
- **过程**: 将文件从 lower 复制到 upper，然后在 upper 层修改
- **结果**: lower 层原文件保持不变，修改仅存在于 upper 层

#### 3.2.2. 新增文件
- **操作**: 直接写入 upper 层
- **特点**: 不影响 lower 层

#### 3.2.3. 删除文件
- **机制**: 创建 whiteout 文件
- **过程**: 在 upper 层创建特殊标记文件
- **结果**: 隐藏 lower 层对应文件，但不实际删除

## 4. Docker 中的应用

### 4.1. 镜像分层
```
容器层 (upper)     ← 可写
─────────────────
应用层 (lower)     ← 只读
基础镜像层 (lower)  ← 只读
系统层 (lower)     ← 只读
```

### 4.2. 优势
- **空间效率**: 多个容器共享相同的镜像层
- **快速启动**: 无需复制整个文件系统
- **隔离性**: 每个容器有独立的 upper 层
- **镜像复用**: 相同的 lower 层可被多个容器使用

## 5. 关键特性

### 5.1. Copy-on-Write (CoW)
- 只在修改时复制文件
- 节省存储空间
- 提高性能

### 5.2. Whiteout 机制
- 用于标记删除的文件
- 不实际删除 lower 层数据
- 保持镜像层不可变性

## 6. 使用场景
- Docker 容器存储驱动
- 容器镜像分层管理
- 轻量级虚拟化环境
- 需要文件系统快照的场景

## 7. 注意事项
- upper 层文件过多会影响性能
- 大文件修改会触发完整复制
- 不适合高 I/O 密集型应用
- 建议将数据卷挂载到宿主机


