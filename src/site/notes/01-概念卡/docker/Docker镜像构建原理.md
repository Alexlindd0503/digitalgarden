---
{"dg-publish":true,"permalink":"/01-概念卡/docker/Docker镜像构建原理/","tags":["docker","镜像原理","文件系统","联合文件系统","概念卡","tech/docker"]}
---

## 1. 核心概念
Docker 镜像采用**分层存储架构**，基于 Union FS（联合文件系统）技术，将多个文件系统层叠加组合，向用户呈现统一的文件系统视图。

## 2. Linux 文件系统基础

### 2.1. 两层结构
```
┌─────────────────────┐
│   rootfs (根文件系统) │ ← /dev /proc /bin /etc 等
├─────────────────────┤
│   bootfs (引导系统)   │ ← bootloader + kernel
└─────────────────────┘
```

**组成部分：**
- **bootfs**: 引导文件系统
  - bootloader: 引导加载程序
  - kernel: 操作系统内核
  - 特点: 不同 Linux 发行版基本相同
  
- **rootfs**: 根文件系统
  - 包含: `/dev`、`/proc`、`/bin`、`/etc` 等标准目录
  - 特点: 不同发行版差异较大（Ubuntu、CentOS 等）

## 3. Docker 镜像分层架构

### 3.1. 层次结构
```
┌──────────────────────┐
│  应用层 (App Layer)   │ ← 应用程序和依赖
├──────────────────────┤
│  中间层 (Lib Layer)   │ ← 库文件和工具
├──────────────────────┤
│  Base Image (rootfs)  │ ← 基础镜像（只读）
├──────────────────────┤
│  bootfs (共享宿主机)   │ ← 复用宿主机内核
└──────────────────────┘
```

### 3.2. 分层说明

#### 3.2.1. bootfs 层（最底层）
- **特点**: 复用宿主机的 bootfs
- **优势**: 
  - 无需在镜像中包含内核
  - 大幅减小镜像体积
  - 容器启动更快

#### 3.2.2. rootfs 层（Base Image）
- **作用**: 提供基础操作系统环境
- **内容**: 基础文件系统结构和工具
- **特性**: 只读层，多个容器可共享

#### 3.2.3. 应用层（上层镜像）
- **内容**: 应用程序、依赖库、配置文件
- **特点**: 可以叠加多层
- **灵活性**: 支持增量构建和复用

## 4. Union FS 联合文件系统

### 4.1. 工作原理
Union FS 将不同的文件系统层整合成一个统一的文件系统，提供单一视图，隐藏底层的多层结构。

### 4.2. 关键特性
- **层叠加**: 多个只读层 + 一个读写层
- **统一视图**: 用户看到的是合并后的完整文件系统
- **透明性**: 隐藏多层存在，操作如同单一文件系统
- **写时复制**: 修改时才复制到可写层

### 4.3. 实现技术
Docker 支持多种 Union FS 实现：
- **OverlayFS**: 主流推荐，性能优秀 → [[01-概念卡/docker/OverlayFS文件系统\|OverlayFS文件系统]]
- **AUFS**: 早期使用，功能完善
- **Btrfs**: 支持快照和克隆
- **Device Mapper**: 块级别存储

## 5. 镜像构建过程

### 5.1. Dockerfile 构建
```dockerfile
FROM ubuntu:20.04          # Base Image (rootfs)
RUN apt-get update         # 新增一层
RUN apt-get install -y app # 新增一层
COPY app /usr/local/bin    # 新增一层
CMD ["app"]                # 元数据，不增加层
```

**每条指令的影响：**
- `FROM`: 指定基础镜像层
- `RUN`: 执行命令，创建新层
- `COPY/ADD`: 添加文件，创建新层
- `CMD/ENTRYPOINT`: 仅修改元数据，不增加层

### 5.2. 分层优势

#### 5.2.1. 存储效率
- 相同的层只存储一份
- 多个镜像共享基础层
- 节省磁盘空间

#### 5.2.2. 传输效率
- 只传输变化的层
- 加速镜像拉取和推送
- 减少网络带宽消耗

#### 5.2.3. 构建效率
- 利用缓存机制
- 未变化的层直接复用
- 加快构建速度

#### 5.2.4. 版本管理
- 每层都有唯一标识
- 支持回滚和追溯
- 便于镜像管理

## 6. 最佳实践

### 6.1. 优化镜像层数
- 合并多个 RUN 命令
- 减少不必要的层
- 使用多阶段构建

### 6.2. 示例对比
```dockerfile
# ❌ 不推荐：创建多层
RUN apt-get update
RUN apt-get install -y pkg1
RUN apt-get install -y pkg2

# ✅ 推荐：合并为一层
RUN apt-get update && \
    apt-get install -y pkg1 pkg2 && \
    rm -rf /var/lib/apt/lists/*
```

## 7. 相关概念
- [[01-概念卡/docker/OverlayFS文件系统\|OverlayFS文件系统]] - Union FS 实现
- [[03-方法卡/docker/Docker离线镜像处理方法\|Docker离线镜像处理方法]] - 镜像操作
- [[03-方法卡/docker/Docker工作目录迁移方法\|Docker工作目录迁移方法]] - 存储管理
- [[03-方法卡/docker/Dockerfile最佳实践\|Dockerfile最佳实践]] - 构建优化

## 8. 关键要点
1. Docker 镜像基于分层存储架构
2. 复用宿主机 bootfs，减小镜像体积
3. Union FS 提供统一文件系统视图
4. 分层设计提高存储、传输和构建效率
5. 合理优化层数可提升镜像性能

